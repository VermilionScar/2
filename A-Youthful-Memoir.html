<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css01.css" media="all" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>A Youthful Memoir</title>
    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --accent-color: #e74c3c;
        --dark-color: #2c3e50;
        --light-color: #ecf0f1;
        --text-color: #333;
        --border-radius: 12px;
        --shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", "楷体", "楷体_GB2312", sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background: linear-gradient(to right, #f0f0f0, #ffffff);
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      .subtitle {
        font-size: 1.3rem;
        opacity: 0.8;
        max-width: 800px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        margin-bottom: 10px;
        padding: 30px;
        background-image: linear-gradient(
          to top,
          #fad0c4 0%,
          #fad0c4 1%,
          #ffd1ff 100%
        );
        color: rgb(255, 255, 255);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }
      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #3498db, #2eccb7, #3498db);
        z-index: 3;
        opacity: 0.12;
      }
      h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.281);
      }
      .gallery-container {
        position: relative;
        min-height: 600px;
      }
      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }
      #sentinel {
        height: 1px;
        width: 100%;
        margin: 20px 0;
      }
      .loading {
        text-align: center;
        padding: 30px;
        color: #000000;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .loading.visible {
        opacity: 1;
      }
      .loader-1 {
        position: relative;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        color: #71b3ff;
        left: -100px;
        -webkit-animation: shadowRolling 2s linear infinite;
        animation: shadowRolling 2s linear infinite;
      }
      @keyframes shadowRolling {
        0% {
          box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0),
            0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
        }
        12% {
          box-shadow: 100px 0 #71b3ff, 0px 0 rgba(255, 255, 255, 0),
            0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
        }
        25% {
          box-shadow: 110px 0 #71b3ff, 100px 0 #71b3ff,
            0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
        }
        36% {
          box-shadow: 120px 0 #71b3ff, 110px 0 #71b3ff, 100px 0 #71b3ff,
            0px 0 rgba(255, 255, 255, 0);
        }
        50% {
          box-shadow: 130px 0 #71b3ff, 120px 0 #71b3ff, 110px 0 #71b3ff,
            100px 0 #71b3ff;
        }
        62% {
          box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 #71b3ff,
            120px 0 #71b3ff, 110px 0 #71b3ff;
        }
        75% {
          box-shadow: 200px 0 rgba(255, 255, 255, 0),
            200px 0 rgba(255, 255, 255, 0), 130px 0 #71b3ff, 120px 0 #71b3ff;
        }
        87% {
          box-shadow: 200px 0 rgba(255, 255, 255, 0),
            200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
            130px 0 #71b3ff;
        }
        100% {
          box-shadow: 200px 0 rgba(255, 255, 255, 0),
            200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0),
            200px 0 rgba(255, 255, 255, 0);
        }
      }
      .loader-2 {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-image: linear-gradient(
          0deg,
          rgba(144, 207, 91, 0.2) 33%,
          #90cf5b 100%
        );
        -webkit-animation: rotation 1s linear infinite;
        animation: rotation 1s linear infinite;
        &:after {
          content: "";
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          width: 44px;
          height: 44px;
          border-radius: 50%;
          background-color: #f0f0f0;
        }
      }
      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .pagination {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 30px;
        flex-wrap: wrap;
      }
      .date-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #ffffff;
        padding: 6px 15px;
        border-radius: 50px;
        box-shadow: var(--shadow);
        margin: 0 auto;
        margin-bottom: 10px;
      }
      .date-centre {
        margin: 0 auto;
      }
      .date-filter label {
        font-weight: 300;
        color: var(--dark-color);
      }
      .date-filter input {
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 10px;
        background: #ffffff;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }
      .search-container {
        display: flex;
        flex: 1;
        min-width: 100px;
        position: relative;
        border-radius: 50px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .search-container input {
        width: 100%;
        padding: 8px 10px;
        border: none;
        font-size: 1rem;
        background: #f8f9fa;
        transition: var(--transition);
      }
      .search-container input:focus {
        outline: none;
        background: #ffffff;
      }
      .search-container button {
        padding: 0 10px;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 300;
        transition: var(--transition);
      }
      .search-container button:hover {
        background: #2980b9;
      }
      .stats {
        text-align: center;
        margin-top: 20px;
        color: #666;
        font-size: 1rem;
        padding: 15px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        padding: 3px 10px;
        border-radius: 30px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .modal.active {
        display: flex;
        opacity: 1;
      }
      .modal-content {
        background: white;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        overflow: auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        transform: translateY(20px);
        transition: transform 0.4s ease;
      }
      .modal.active .modal-content {
        transform: translateY(0);
      }
      .modal-header {
        height: 50px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 15px;
        background: var(--primary-color);
        color: white;
      }
      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .image-card {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
        cursor: pointer;
      }
      .image-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }
      .image-placeholder {
        width: 100%;
        height: 220px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
      }
      .thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        transition: transform 0.3s ease;
      }
      .image-card:hover .thumbnail {
        transform: scale(1.05);
      }
      .image-info {
        padding: 4px;
      }
      .image-title {
        font-weight: 700;
        margin-bottom: 6px;
        font-size: 1.15rem;
        color: var(--dark-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .image-id {
        font-size: 0.9rem;
        color: #7f8c8d;
        background: #f1f2f6;
        padding: 3px 8px;
        border-radius: 4px;
      }
      .image-meta {
        color: #666;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
      }
      .image-date {
        color: #3498db;
        font-weight: 500;
      }
      .page-btn {
        padding: 10px 18px;
        background: white;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        min-width: 45px;
        text-align: center;
        font-weight: 600;
      }
      .page-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
      }
      .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
      }
      .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .modal-body {
        padding: 30px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }
      .modal-image {
        background: #f8f9fa;
        border-radius: var(--border-radius);
        height: 350px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .modal-image img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .modal-details {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .detail-item {
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      .detail-label {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 8px;
        font-size: 1.1rem;
      }
      .detail-value {
        color: #555;
        line-height: 1.7;
      }
      .modal-footer {
        padding: 20px;
        display: flex;
        justify-content: flex-end;
        background: #f8f9fa;
        border-top: 1px solid #eee;
      }
      .action-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .download-btn {
        background: var(--secondary-color);
        color: white;
      }
      .download-btn:hover {
        background: #27ae60;
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(46, 204, 113, 0.3);
      }
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: var(--secondary-color);
        color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        z-index: 2000;
        transform: translateX(150%);
        transition: transform 0.3s ease;
      }
      .notification.show {
        transform: translateX(0);
      }
      .error {
        background: var(--accent-color);
      }
      .thumbnail-error {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        text-align: center;
        padding: 15px;
      }
      .thumbnail-error i {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--accent-color);
      }
      .thumbnail-error div {
        font-size: 0.9rem;
      }
      @media (max-width: 800px) {
        .gallery {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }
        .image-placeholder {
          height: 180px;
        }
        .modal-header {
          height: 40px;
        }
        .modal-title {
          font-size: 1.3rem;
          font-weight: 600;
        }
        .modal-body {
          padding: 20px;
          display: grid;
          grid-template-columns: 1fr;
          gap: 13px;
        }
        .modal-details {
          font-size: 1rem;
          display: flex;
          flex-direction: column;
          gap: 9px;
        }
        .detail-item {
          padding-bottom: 4px;
          border-bottom: 1px solid #eee;
        }
        .detail-label {
          margin-bottom: 6px;
          font-size: 0.9rem;
        }
        .detail-value {
          color: #555;
          line-height: 0.9;
        }
        .close-btn {
          font-size: 1.5rem;
          width: 30px;
          height: 30px;
        }
        .modal-footer {
          padding: 15px;
        }
      }
      @media (max-width: 480px) {
        .gallery {
          grid-template-columns: repeat(2, 1fr);
          gap: 6px;
        }
        .image-placeholder {
          height: 120px;
        }
        .image-title {
          font-size: 0.7rem;
          font-weight: 600;
        }
        .image-id {
          font-size: 0.6rem;
          padding: 2px 8px;
        }
        .image-meta {
          font-size: 0.5rem;
        }
        .modal-header {
          height: 30px;
        }
        .modal-title {
          font-size: 1.1rem;
          font-weight: 500;
        }
        .modal-body {
          padding: 10px;
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .modal-details {
          font-size: 0.8rem;
          display: flex;
          flex-direction: column;
          gap: 7px;
        }
        .detail-item {
          padding-bottom: 2px;
          border-bottom: 1px solid #eee;
        }
        .detail-label {
          margin-bottom: 4px;
          font-size: 0.7rem;
        }
        .detail-value {
          color: #555;
          line-height: 0.7;
        }
        .modal-footer {
          padding: 13px;
        }
        .action-btn {
          padding: 6px 25px;
          border-radius: 50px;
          gap: 2px;
        }
        .close-btn {
          font-size: 1.3rem;
          width: 25px;
          height: 25px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1 class="text-style-1"><i class="fas fa-images"></i>青春回忆录</h1>
        <p class="subtitle text-style-1">致我们已逝的青春</p>
      </header>

      <div class="controls">
        <div class="search-container">
          <input
            tyoe="text"
            id="searchInput"
            placeholder="输入信息以搜索图片..."
          />
          <button id="searchBtn"><i class="fas fa-search"></i>搜索</button>
        </div>
      </div>

      <div class="date-filter">
        <div class="date-centre">
          <label for="date-filter">
            <i class="fas fa-calendar-alt"><i>选择想要的日期 </i></i>
          </label>
          <input style="padding: 4px 9px" type="date" id="dateFilter" />
          <!-- 添加清除按钮 -->
          <button
            id="clearDateFilter"
            style="
              margin-left: 10px;
              padding: 4px 9px;
              background: #e74c3c;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            清除
          </button>
        </div>
      </div>

      <div class="gallery-container">
        <div class="gallery" id="imageGallery"></div>
        <div id="sentinel"></div>
        <div class="loading" id="loadingIndicator">
          <div class="loader-1"></div>
          正在加载您的时光，请稍后...
        </div>
      </div>

      <div class="pagination" id="pagination"></div>

      <div class="stats" id="stats">
        <div class="stat-item">
          <i class="fas fa-images"></i>
          <span>总图片数：<span id="totalImages">0</span>张</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-filter"></i>
          <span>当前显示：<span id="filteredImages">0</span>张</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-calendar"></i>
          <span>日期：<span id="dateFilterStatus">全部范围</span></span>
        </div>
      </div>
    </div>

    <div class="modal" id="imageModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">图片详情</div>
          <button class="close-btn" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-image" id="modalImage">
            <div class="loader-2"></div>
          </div>
          <div class="modal-details">
            <div class="detail-item">
              <div class="detail-label">图片ID</div>
              <div class="detail-value" id="detailId">#0000</div>
            </div>
            <div>
              <div class="detail-label">文件名</div>
              <div class="detail-value" id="detailFilename">无名氏</div>
            </div>
            <div>
              <div class="detail-label">尺寸</div>
              <div class="detdiv-value" id="detailDimensions">0 × 0 像素</div>
            </div>
            <div>
              <div class="detail-label">文件大小</div>
              <div class="divtail-value" id="detailSize">0 KB</div>
            </div>
            <div>
              <div class="detail-label">拍摄日期</div>
              <div class="detail-value" id="detailDate">2023-01-01</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn download-btn" id="downloadBtn">
            <i class="fas fa-download"></i>下载
          </button>
        </div>
      </div>
    </div>
    <div class="notification" id="notification"></div>
    <script>
      const OSS_BASE_URL = "https://ye1image.oss-cn-chengdu.aliyuncs.com";
      const JSON_INDEX_URL = `${OSS_BASE_URL}/json/index.json`;
      const THUMBNAILS_URL = `${OSS_BASE_URL}/thumbnails/`;
      const ORIGINAL_IMAGES_URL = `${OSS_BASE_URL}/images/`;

      const IMAGES_PER_PAGE = 24;
      let currentPage = 0;
      let currentSearch = "";
      let currentDateFilter = "";
      let allImages = [];
      let filteredImages = [];
      let isLoading = false;
      let totalImageCount = 0;

      const galleryElement = document.getElementById("imageGallery");
      const paginationElement = document.getElementById("pagination");
      const statsElement = document.getElementById("stats");
      const totalImagesElement = document.getElementById("totalImages");
      const filteredImagesElement = document.getElementById("filteredImages");
      const dateFilterStatus = document.getElementById("dateFilterStatus");
      const loadingElement = document.getElementById("loadingIndicator");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const dateFilter = document.getElementById("dateFilter");
      const clearDateFilter = document.getElementById("clearDateFilter");
      const sentinelElement = document.getElementById("sentinel");
      const imageModal = document.getElementById("imageModal");
      const closeModal = document.getElementById("closeModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalImage = document.getElementById("modalImage");
      const detailId = document.getElementById("detailId");
      const detailFilename = document.getElementById("detailFilename");
      const detailDimensions = document.getElementById("detailDimensions");
      const detailSize = document.getElementById("detailSize");
      const detailDate = document.getElementById("detailDate");
      const downloadBtn = document.getElementById("downloadBtn");
      const notificationElement = document.getElementById("notification");

      document.addEventListener("DOMContentLoaded", () => {
        fetchImageData();
        setupEventListeners();
      });

      function setupEventListeners() {
        searchBtn.addEventListener("click", performSearch);

        searchInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            performSearch();
          }
        });

        dateFilter.addEventListener("change", (e) => {
          currentDateFilter = e.target.value;
          currentPage = 1;
          filterImages();
          renderGallery();
          renderPagination();
          updateStats();
        });

        clearDateFilter.addEventListener("click", () => {
          dateFilter.value = "";
          currentDateFilter = "";
          currentPage = 1;
          filterImages();
          renderGallery();
          renderPagination();
          updateStats();
        });

        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentSearch = e.target.value.trim().toLowerCase();
            currentPage = 1;
            filterImages();
            renderGallery();
            renderPagination();
            updateStats();
          }, 500);
        });

        closeModal.addEventListener("click", () => {
          imageModal.classList.remove("active");
        });

        imageModal.addEventListener("click", (e) => {
          if (e.target === imageModal) {
            imageModal.classList.remove("active");
          }
        });

        downloadBtn.addEventListener("click", downloadImage);
      }

      function showNotification(message, isError = false) {
        notificationElement.textContent = message;
        notificationElement.className = "notification";
        if (isError) {
          notificationElement.classList.add("error");
        }
        notificationElement.classList.add("show");

        setTimeout(() => {
          notificationElement.classList.remove("show");
        }, 3000);
      }

      function fetchImageData() {
        isLoading = true;
        loadingElement.classList.add("visible");

        const timestamp = new Date().getTime();
        const url = `${JSON_INDEX_URL}?t=${timestamp}`;

        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP错误! 状态码: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (!Array.isArray(data)) {
              throw new Error("图片数据格式错误: 期望数组但收到其他格式");
            }

            if (data.length === 0) {
              showNotification("图片数据为空", true);
            }

            allImages = data.map((img) => {
              return {
                ...img,
                thumbnail: img.thumbnail,
              };
            });

            totalImageCount = allImages.length;
            filteredImages = [...allImages];
            totalImagesElement.textContent = totalImageCount.toLocaleString();

            filterImages();
            renderGallery();
            renderPagination();
            updateStats();

            isLoading = false;
            loadingElement.classList.remove("visible");

            setupIntersectionObserver();

            showNotification(`成功加载 ${totalImageCount} 张图片`);
          })
          .catch((error) => {
            console.error("加载图片数据错误:", error);
            isLoading = false;
            loadingElement.classList.remove("visible");
            loadingElement.innerHTML = `
                        <div style="color: var(--accent-color);">
                            <i class="fas fa-exclamation-triangle"></i> 加载图片数据失败
                            <p style="margin-top: 10px; font-size: 0.9rem;">${error.message}</p>
                        </div>
                        <button id="retryBtn" style="margin-top: 15px; padding: 8px 20px; 
                            background: var(--primary-color); color: white; border: none; 
                            border-radius: 30px; cursor: pointer;">
                            重试
                        </button>
                    `;

            document
              .getElementById("retryBtn")
              .addEventListener("click", fetchImageData);
            showNotification("加载图片数据失败，请重试", true);
          });
      }

      function performSearch() {
        currentSearch = searchInput.value.trim().toLowerCase();
        currentPage = 1;
        filterImages();
        renderGallery();
        renderPagination();
        updateStats();
      }

      function setupIntersectionObserver() {
        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting && !isLoading) {
              if (currentPage * IMAGES_PER_PAGE < filteredImages.length) {
                currentPage++;
                renderGallery();
                renderPagination();
                updateStats();
              }
            }
          },
          {
            rootMargin: "200px",
            threshold: 0.01,
          }
        );

        observer.observe(sentinelElement);
      }

      function filterImages() {
        if (!currentSearch && !currentDateFilter) {
          filteredImages = [...allImages];
        } else {
          filteredImages = allImages.filter((img) => {
            const matchSearch = currentSearch
              ? img.id.toString().includes(currentSearch) ||
                img.filename.toLowerCase().includes(currentSearch)
              : true;

            const matchDate = currentDateFilter
              ? img.date_taken.startsWith(currentDateFilter)
              : true;

            return matchSearch && matchDate;
          });
        }

        updateStats();
      }

      function updateStats() {
        filteredImagesElement.textContent =
          filteredImages.length.toLocaleString();

        dateFilterStatus.textContent = currentDateFilter
          ? currentDateFilter
          : "未启用";

        dateFilterStatus.style.color = currentDateFilter
          ? "var(--secondary-color)"
          : "inherit";
      }

      function renderGallery() {
        if (isLoading) return;

        const startIndex = (currentPage - 1) * IMAGES_PER_PAGE;
        const endIndex = Math.min(
          startIndex + IMAGES_PER_PAGE,
          filteredImages.length
        );
        const pageImages = filteredImages.slice(startIndex, endIndex);

        if (currentPage === 1) {
          galleryElement.innerHTML = "";
        }

        pageImages.forEach((img) => {
          const card = document.createElement("div");
          card.className = "image-card";
          card.dataset.id = img.id;

          const thumbnailUrl = `${OSS_BASE_URL}/${img.thumbnail}`;

          const placeholder = document.createElement("div");
          placeholder.className = "image-placeholder";

          const thumbnailImg = document.createElement("img");
          thumbnailImg.className = "thumbnail";
          thumbnailImg.src = thumbnailUrl;
          thumbnailImg.alt = img.filename;

          let retryCount = 0;
          thumbnailImg.onerror = function () {
            retryCount++;
            if (retryCount <= 2) {
              thumbnailImg.src = `${thumbnailUrl}?retry=${retryCount}&t=${Date.now()}`;
            } else {
              const errorDiv = document.createElement("div");
              errorDiv.className = "thumbnail-error";
              errorDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>缩略图加载失败</div>
                        `;
              placeholder.innerHTML = "";
              placeholder.appendChild(errorDiv);
            }
          };

          placeholder.appendChild(thumbnailImg);

          const imageInfo = document.createElement("div");
          imageInfo.className = "image-info";

          const imageTitle = document.createElement("div");
          imageTitle.className = "image-title";

          const titleText = document.createElement("span");
          titleText.textContent =
            img.filename.length > 20
              ? img.filename.substring(0, 20) + "..."
              : img.filename;

          const imageId = document.createElement("span");
          imageId.className = "image-id";
          imageId.textContent = `#${img.id}`;

          imageTitle.appendChild(titleText);
          imageTitle.appendChild(imageId);

          const imageMeta = document.createElement("div");
          imageMeta.className = "image-meta";

          const dimensions = document.createElement("span");
          dimensions.textContent = `${img.width}×${img.height}`;

          const size = document.createElement("span");
          size.textContent = formatFileSize(img.size);

          const date = document.createElement("span");
          date.className = "image-date";
          date.textContent = img.date_taken.split("T")[0];

          imageMeta.appendChild(dimensions);
          imageMeta.appendChild(size);
          imageMeta.appendChild(date);

          imageInfo.appendChild(imageTitle);
          imageInfo.appendChild(imageMeta);

          card.appendChild(placeholder);
          card.appendChild(imageInfo);

          card.addEventListener("click", () => showImageDetail(img));

          galleryElement.appendChild(card);
        });
      }

      function showImageDetail(img) {
        modalTitle.textContent = img.filename;
        detailId.textContent = `#${img.id}`;
        detailFilename.textContent = img.filename;
        detailDimensions.textContent = `${img.width} × ${img.height} 像素`;
        detailSize.textContent = formatFileSize(img.size);

        if (img.date_taken) {
          const dateParts = img.date_taken.split("T");
          const timePart = dateParts[1]
            ? dateParts[1].split(":").slice(0, 2).join(":")
            : "";
          detailDate.textContent = `${dateParts[0]} ${timePart}`;
        } else {
          detailDate.textContent = "未知";
        }

        downloadBtn.dataset.filename = img.filename;

        modalImage.innerHTML = '<div class="loader"></div>';

        const thumbnailUrl = `${OSS_BASE_URL}/${img.thumbnail}`;

        const imgElement = document.createElement("img");
        imgElement.src = thumbnailUrl;
        imgElement.alt = img.filename;
        imgElement.onload = () => {
          modalImage.innerHTML = "";
          modalImage.appendChild(imgElement);
        };
        imgElement.onerror = () => {
          modalImage.innerHTML = `<div style="text-align: center; padding: 20px; color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle fa-3x"></i>
                    <p style="margin-top: 15px;">缩略图加载失败</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">${thumbnailUrl}</p>
                </div>`;
        };

        imageModal.classList.add("active");
      }

      function downloadImage() {
        const filename = downloadBtn.dataset.filename;
        if (!filename) return;

        const imageUrl = `${ORIGINAL_IMAGES_URL}${filename}`;

        const link = document.createElement("a");
        link.href = imageUrl;
        link.download = filename;
        link.target = "_blank";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification(`开始下载: ${filename}`);
      }

      function renderPagination() {
        const totalPages = Math.ceil(filteredImages.length / IMAGES_PER_PAGE);

        if (totalPages <= 1) {
          paginationElement.innerHTML = "";
          return;
        }

        paginationElement.innerHTML = "";

        const maxVisiblePages = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (currentPage > 1) {
          const prevBtn = document.createElement("button");
          prevBtn.className = "page-btn";
          prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
          prevBtn.addEventListener("click", () => {
            currentPage--;
            renderGallery();
            renderPagination();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
          paginationElement.appendChild(prevBtn);
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.className = `page-btn ${i === currentPage ? "active" : ""}`;
          btn.textContent = i;
          btn.addEventListener("click", () => {
            currentPage = i;
            renderGallery();
            renderPagination();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
          paginationElement.appendChild(btn);
        }

        if (currentPage < totalPages) {
          const nextBtn = document.createElement("button");
          nextBtn.className = "page-btn";
          nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
          nextBtn.addEventListener("click", () => {
            currentPage++;
            renderGallery();
            renderPagination();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
          paginationElement.appendChild(nextBtn);
        }
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        else return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }
    </script>
  </body>
</html>
